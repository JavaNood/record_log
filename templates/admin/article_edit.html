{% extends "admin/base.html" %}

{% block title %}{% if is_new %}æ–°å»ºæ–‡ç« {% else %}ç¼–è¾‘æ–‡ç« {% endif %}{% endblock %}
{% block page_title %}{% if is_new %}æ–°å»ºæ–‡ç« {% else %}ç¼–è¾‘æ–‡ç« {% endif %}{% endblock %}
{% block page_subtitle %}{% if is_new %}åˆ›å»ºæ–°çš„æ–‡ç« å†…å®¹{% else %}ä¿®æ”¹æ–‡ç« å†…å®¹å’Œè®¾ç½®{% endif %}{% endblock %}

{% block content %}
<div class="admin-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">
            <i class="fas fa-{% if is_new %}plus{% else %}edit{% endif %} me-2"></i>{% if is_new %}æ–°å»ºæ–‡ç« {% else %}ç¼–è¾‘æ–‡ç« {% endif %}
        </h4>
        <div>
            <a href="{{ url_for('admin.articles') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>è¿”å›åˆ—è¡¨
            </a>
        </div>
    </div>

    <form method="POST" id="articleEditForm" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        
        <!-- æ–‡ç« æ ‡é¢˜ -->
        <div class="mb-4">
            {{ form.title.label(class="form-label fw-bold") }}
            {{ form.title() }}
            {% if form.title.errors %}
                <div class="text-danger small mt-1">
                    {% for error in form.title.errors %}
                        <div>{{ error }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Markdownç¼–è¾‘å™¨åŒºåŸŸ -->
        <div class="mb-4">
            {{ form.content.label(class="form-label fw-bold") }}
            <div class="markdown-editor-container">
                <div class="editor-toolbar mb-2">
                    <div class="btn-group btn-group-sm me-2" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('**', '**', 'ç²—ä½“æ–‡å­—')" title="ç²—ä½“">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('*', '*', 'æ–œä½“æ–‡å­—')" title="æ–œä½“">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('`', '`', 'ä»£ç ')" title="ä»£ç ">
                            <i class="fas fa-code"></i>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm me-2" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('# ', '', 'ä¸€çº§æ ‡é¢˜')" title="æ ‡é¢˜">
                            <i class="fas fa-heading"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('- ', '', 'åˆ—è¡¨é¡¹')" title="åˆ—è¡¨">
                            <i class="fas fa-list"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('[', '](https://)', 'é“¾æ¥æ–‡å­—')" title="é“¾æ¥">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm me-2" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="insertImage()" title="æ’å…¥å›¾ç‰‡">
                            <i class="fas fa-image"></i>
                        </button>
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" title="å›¾ç‰‡é€‰é¡¹">
                                <span class="visually-hidden">åˆ‡æ¢ä¸‹æ‹‰èœå•</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><button class="dropdown-item" type="button" onclick="insertImageWithSize('small')">
                                    <i class="fas fa-compress-alt me-2"></i>å°å›¾ (25%)
                                </button></li>
                                <li><button class="dropdown-item" type="button" onclick="insertImageWithSize('medium')">
                                    <i class="fas fa-expand-arrows-alt me-2"></i>ä¸­å›¾ (50%)
                                </button></li>
                                <li><button class="dropdown-item" type="button" onclick="insertImageWithSize('large')">
                                    <i class="fas fa-expand me-2"></i>å¤§å›¾ (75%)
                                </button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" type="button" onclick="insertImageWithAlign('left')">
                                    <i class="fas fa-align-left me-2"></i>å·¦å¯¹é½
                                </button></li>
                                <li><button class="dropdown-item" type="button" onclick="insertImageWithAlign('center')">
                                    <i class="fas fa-align-center me-2"></i>å±…ä¸­å¯¹é½
                                </button></li>
                                <li><button class="dropdown-item" type="button" onclick="insertImageWithAlign('right')">
                                    <i class="fas fa-align-right me-2"></i>å³å¯¹é½
                                </button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" type="button" onclick="insertImageInline()">
                                    <i class="fas fa-grip-horizontal me-2"></i>å¹¶æ’æ’å…¥
                                </button></li>
                            </ul>
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-info" onclick="togglePreview()" id="previewToggle">
                            <i class="fas fa-eye"></i> é¢„è§ˆ
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="testMarkdown()" title="æ’å…¥æµ‹è¯•å†…å®¹">
                            <i class="fas fa-vial"></i> æµ‹è¯•
                        </button>
                    </div>
                </div>
                
                <div class="editor-content-wrapper">
                    <div id="editor-input" class="editor-pane">
                        {{ form.content() }}
                    </div>
                    <div id="editor-preview" class="editor-pane preview-pane" style="display: none;">
                        <div id="previewContent" class="preview-content">
                            <!-- å®æ—¶é¢„è§ˆå†…å®¹ -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-text">æ”¯æŒMarkdownæ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨å·¥å…·æ å¿«é€Ÿæ’å…¥æ ¼å¼æˆ–ç›´æ¥è¾“å…¥Markdownè¯­æ³•</div>
            {% if form.content.errors %}
                <div class="text-danger small mt-1">
                    {% for error in form.content.errors %}
                        <div>{{ error }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- è®¾ç½®åŒºåŸŸ -->
        <div class="row mb-4">
            <!-- æ–‡ç« æƒé™ -->
            <div class="col-md-3 mb-3">
                {{ form.permission.label(class="form-label fw-bold") }}
                {{ form.permission() }}
            </div>

            <!-- å‘å¸ƒçŠ¶æ€ -->
            <div class="col-md-3 mb-3">
                {{ form.status.label(class="form-label fw-bold") }}
                {{ form.status() }}
            </div>

            <!-- è‡ªå®šä¹‰æµè§ˆæ•° -->
            <div class="col-md-3 mb-3">
                {{ form.view_count.label(class="form-label fw-bold") }}
                {{ form.view_count() }}
                <div class="form-text">è‡ªå®šä¹‰æ–‡ç« æµè§ˆæ•°</div>
                {% if form.view_count.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in form.view_count.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- ç½®é¡¶è®¾ç½® -->
            <div class="col-md-3 mb-3">
                <label class="form-label fw-bold d-block">å…¶ä»–è®¾ç½®</label>
                <div class="form-check">
                    {{ form.is_top() }}
                    {{ form.is_top.label(class="form-check-label") }}
                </div>
            </div>
        </div>

        <!-- æ ‡ç­¾é€‰æ‹©åŒºåŸŸ -->
        <div class="mb-4">
            <h6 class="fw-bold text-primary">
                <i class="fas fa-tags me-2"></i>æ–‡ç« æ ‡ç­¾
            </h6>
            
            {% if all_tags %}
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                é€‰æ‹©ä¸æ–‡ç« å†…å®¹ç›¸å…³çš„æ ‡ç­¾ï¼Œæœ‰åŠ©äºæ–‡ç« åˆ†ç±»å’Œæ£€ç´¢ã€‚
            </div>
            
            <div class="row">
                {% for tag in all_tags %}
                <div class="col-md-3 col-sm-4 col-6 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               id="tag_{{ tag.id }}" 
                               name="tags" 
                               value="{{ tag.id }}"
                               {% if form.tags.data and tag.id in form.tags.data %}checked{% endif %}>
                        <label class="form-check-label d-flex align-items-center" for="tag_{{ tag.id }}">
                            <span class="badge me-2" style="background-color: {{ tag.color }}">
                                {{ tag.name }}
                            </span>
                        </label>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-lightbulb me-1"></i>
                    æç¤ºï¼šå¯ä»¥åœ¨<a href="{{ url_for('admin.tags') }}" target="_blank">æ ‡ç­¾ç®¡ç†é¡µé¢</a>åˆ›å»ºæ–°çš„æ ‡ç­¾
                </small>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-circle me-2"></i>
                è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•æ ‡ç­¾ã€‚<a href="{{ url_for('admin.tags') }}" target="_blank">ç«‹å³å‰å¾€åˆ›å»ºæ ‡ç­¾</a>
            </div>
            {% endif %}
        </div>

        <!-- éªŒè¯è®¾ç½®åŒºåŸŸ -->
        <div id="verificationSection" class="mb-4" style="display: none;">
            <h6 class="fw-bold text-warning">
                <i class="fas fa-lock me-2"></i>è®¿é—®éªŒè¯è®¾ç½®
            </h6>
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                å½“æ–‡ç« æƒé™è®¾ä¸º"éœ€è¦éªŒè¯"æ—¶ï¼Œç”¨æˆ·éœ€è¦å›ç­”æ­£ç¡®çš„éªŒè¯é—®é¢˜æ‰èƒ½æŸ¥çœ‹æ–‡ç« å†…å®¹ã€‚
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ form.verify_question.label(class="form-label fw-bold") }}
                    {{ form.verify_question() }}
                    {% if form.verify_question.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.verify_question.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    {{ form.verify_answer.label(class="form-label fw-bold") }}
                    {{ form.verify_answer() }}
                    {% if form.verify_answer.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.verify_answer.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                {% if not is_new %}
                    æ–‡ç« ID: {{ article.id }} | 
                    åˆ›å»ºæ—¶é—´: {{ article.created_at.strftime('%Y-%m-%d %H:%M') }} | 
                    æœ€åæ›´æ–°: {{ article.updated_at.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                    ä½¿ç”¨ Ctrl+S å¿«é€Ÿä¿å­˜ï¼ŒCtrl+P å¿«é€Ÿé¢„è§ˆ
                {% endif %}
            </div>
            <div>
                <button type="button" class="btn btn-outline-secondary me-2" onclick="previewArticle()">
                    <i class="fas fa-eye me-2"></i>é¢„è§ˆ
                </button>
                {{ form.submit() }}
            </div>
        </div>
    </form>
</div>

<!-- é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>æ–‡ç« é¢„è§ˆ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <div id="modalPreviewContent">
                    <!-- é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­é¢„è§ˆ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Markdownç¼–è¾‘å™¨æ ·å¼ */
    .markdown-editor-container {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .editor-toolbar {
        background: #f8f9fa;
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .editor-content-wrapper {
        display: flex;
        min-height: 400px;
    }
    
    .editor-pane {
        flex: 1;
        padding: 0;
    }
    
    #article-content {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        line-height: 1.6;
        resize: none;
        border: none;
        outline: none;
        padding: 1rem;
        min-height: 400px;
        width: 100%;
    }
    
    .preview-pane {
        border-left: 1px solid #dee2e6;
        background: #f8f9fa;
    }
    
    .preview-content {
        padding: 1rem;
        min-height: 400px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    #article-title {
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    .form-label.fw-bold {
        color: #495057;
        margin-bottom: 0.75rem;
    }
    
    .admin-card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    /* é¢„è§ˆåŒºåŸŸæ ·å¼ */
    #modalPreviewContent, .preview-content {
        background: white;
        border-radius: 0.375rem;
    }
    
    .preview-content h1, .preview-content h2, .preview-content h3,
    #modalPreviewContent h1, #modalPreviewContent h2, #modalPreviewContent h3 {
        color: #212529;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .preview-content p, #modalPreviewContent p {
        line-height: 1.8;
        margin-bottom: 1rem;
    }
    
    .preview-content code, #modalPreviewContent code {
        background: #e9ecef;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
    }
    
    .preview-content pre, #modalPreviewContent pre {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
        overflow-x: auto;
    }
    
    .preview-content blockquote, #modalPreviewContent blockquote {
        border-left: 4px solid #dee2e6;
        padding-left: 1rem;
        margin: 1rem 0;
        color: #6c757d;
    }
    
    /* éªŒè¯è®¾ç½®åŒºåŸŸ */
    #verificationSection {
        background: #fffbf0;
        border: 1px solid #ffeaa7;
        border-radius: 0.375rem;
        padding: 1.5rem;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .modal-dialog.modal-xl {
            margin: 0.5rem;
            max-width: calc(100% - 1rem);
        }
        
        .editor-content-wrapper {
            flex-direction: column;
        }
        
        .preview-pane {
            border-left: none;
            border-top: 1px solid #dee2e6;
        }
        
        #article-content {
            min-height: 300px;
        }
    }
</style>

<!-- å¼•å…¥Markdownè§£æåº“ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
{% endblock %}

{% block extra_js %}
<!-- Markdownè§£æå’Œè¯­æ³•é«˜äº® -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/5.1.1/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('articleEditForm');
    const submitBtn = document.getElementById('submit-btn');
    const titleField = document.getElementById('article-title');
    const contentField = document.getElementById('article-content');
    const permissionField = document.getElementById('article-permission');
    const verificationSection = document.getElementById('verificationSection');
    const previewContent = document.getElementById('previewContent');
    
    let isPreviewMode = false;
    
    // ç­‰å¾…markedåº“åŠ è½½å®Œæˆåé…ç½®
    function initializeMarked() {
        if (typeof marked !== 'undefined') {
            // é…ç½®markedè§£æå™¨
            marked.setOptions({
                highlight: function(code, lang) {
                    if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {
                            console.log('Highlight error:', err);
                        }
                    }
                    return typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code;
                },
                breaks: true,
                gfm: true,
                headerIds: false,
                mangle: false
            });
            console.log('Markedåˆå§‹åŒ–æˆåŠŸ');
        } else {
            console.error('Markedåº“æœªåŠ è½½');
        }
    }
    
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿åº“åŠ è½½å®Œæˆ
    setTimeout(initializeMarked, 500);
    
    // æƒé™å˜æ›´å¤„ç† - ä¿®å¤æ˜¾ç¤ºé—®é¢˜
    function toggleVerificationSection() {
        console.log('æƒé™å˜æ›´:', permissionField.value);
        if (permissionField.value === 'verify') {
            verificationSection.style.display = 'block';
            console.log('æ˜¾ç¤ºéªŒè¯è®¾ç½®åŒºåŸŸ');
        } else {
            verificationSection.style.display = 'none';
            console.log('éšè—éªŒè¯è®¾ç½®åŒºåŸŸ');
        }
    }
    
    // ç¡®ä¿æƒé™å­—æ®µå­˜åœ¨å¹¶ç»‘å®šäº‹ä»¶
    if (permissionField) {
        permissionField.addEventListener('change', toggleVerificationSection);
        // é¡µé¢åŠ è½½æ—¶ç«‹å³æ£€æŸ¥æƒé™çŠ¶æ€
        toggleVerificationSection();
    } else {
        console.error('æƒé™å­—æ®µæœªæ‰¾åˆ°');
    }
    
    // å®æ—¶é¢„è§ˆæ›´æ–° - ä¿®å¤markdownæ¸²æŸ“
    function updatePreview() {
        if (!isPreviewMode || !previewContent) return;
        
        const title = titleField.value;
        const content = contentField.value;
        
        let html = '';
        
        if (title.trim()) {
            html += `<h1>${escapeHtml(title)}</h1>`;
        }
        
        if (content.trim()) {
            try {
                if (typeof marked !== 'undefined') {
                    html += marked.parse(content);
                } else {
                    // å¦‚æœmarkedæ²¡æœ‰åŠ è½½ï¼Œä½¿ç”¨ç®€å•çš„è½¬æ¢
                    html += simpleMarkdownToHtml(content);
                }
            } catch (e) {
                console.error('Markdownè§£æé”™è¯¯:', e);
                html += `<pre>${escapeHtml(content)}</pre>`;
            }
        }
        
        previewContent.innerHTML = html || '<p class="text-muted">æš‚æ— å†…å®¹</p>';
        console.log('é¢„è§ˆå·²æ›´æ–°');
    }
    
    // åˆ‡æ¢é¢„è§ˆæ¨¡å¼ - ä¿®å¤é¢„è§ˆåˆ‡æ¢
    window.togglePreview = function() {
        const editorInput = document.getElementById('editor-input');
        const editorPreview = document.getElementById('editor-preview');
        const toggleBtn = document.getElementById('previewToggle');
        
        if (!editorInput || !editorPreview || !toggleBtn) {
            console.error('é¢„è§ˆå…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        isPreviewMode = !isPreviewMode;
        
        if (isPreviewMode) {
            editorInput.style.display = 'none';
            editorPreview.style.display = 'block';
            toggleBtn.innerHTML = '<i class="fas fa-edit"></i> ç¼–è¾‘';
            updatePreview();
            console.log('åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼');
        } else {
            editorInput.style.display = 'block';
            editorPreview.style.display = 'none';
            toggleBtn.innerHTML = '<i class="fas fa-eye"></i> é¢„è§ˆ';
            console.log('åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼');
        }
    };
    
    // Markdownå·¥å…·æ åŠŸèƒ½ - ç¡®ä¿åŠŸèƒ½æ­£å¸¸
    window.insertMarkdown = function(before, after, placeholder) {
        if (!contentField) {
            console.error('å†…å®¹å­—æ®µæœªæ‰¾åˆ°');
            return;
        }
        
        const start = contentField.selectionStart;
        const end = contentField.selectionEnd;
        const selectedText = contentField.value.substring(start, end);
        const replacement = before + (selectedText || placeholder) + after;
        
        contentField.value = contentField.value.substring(0, start) + replacement + contentField.value.substring(end);
        contentField.focus();
        
        // è®¾ç½®å…‰æ ‡ä½ç½®
        if (selectedText) {
            contentField.setSelectionRange(start + before.length, start + before.length + selectedText.length);
        } else {
            contentField.setSelectionRange(start + before.length, start + before.length + placeholder.length);
        }
        
        updatePreview();
        console.log('æ’å…¥markdown:', before + placeholder + after);
    };
    
    // æ’å…¥å›¾ç‰‡
    window.insertImage = function() {
        const imageUpload = document.getElementById('imageUpload');
        if (imageUpload) {
            imageUpload.click();
        } else {
            console.error('å›¾ç‰‡ä¸Šä¼ å…ƒç´ æœªæ‰¾åˆ°');
        }
    };
    
    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    window.handleImageUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'warning');
            return;
        }
        
        // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
        showMessage('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'info');
        
        // åˆ›å»ºFormDataå¯¹è±¡
        const formData = new FormData();
        formData.append('image', file);
        
        // ä¸Šä¼ åˆ°æœåŠ¡å™¨
        fetch('/admin/upload-image', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // æ’å…¥å›¾ç‰‡markdown
                const imageMarkdown = `![å›¾ç‰‡](${data.image_url})`;
                insertMarkdown('', '', imageMarkdown);
                showMessage(data.message, 'success');
            } else {
                showMessage(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
            showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        });
        
        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
        event.target.value = '';
    };
    
    // æ’å…¥æŒ‡å®šå¤§å°çš„å›¾ç‰‡
    window.insertImageWithSize = function(size) {
        const imageUpload = document.getElementById('imageUpload');
        if (imageUpload) {
            // è®¾ç½®ä¸Šä¼ å®Œæˆåçš„å›è°ƒ
            imageUpload.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'warning');
                    return;
                }
                
                showMessage('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'info');
                
                const formData = new FormData();
                formData.append('image', file);
                
                fetch('/admin/upload-image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let sizeStyle = '';
                        switch(size) {
                            case 'small':
                                sizeStyle = ' width="25%"';
                                break;
                            case 'medium':
                                sizeStyle = ' width="50%"';
                                break;
                            case 'large':
                                sizeStyle = ' width="75%"';
                                break;
                        }
                        
                        const imageHtml = `<img src="${data.image_url}" alt="${data.filename}"${sizeStyle} style="border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
                        insertMarkdown('', '', imageHtml);
                        showMessage(`å·²æ’å…¥${getSizeText(size)}`, 'success');
                    } else {
                        showMessage(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
                    showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
                });
                
                event.target.value = '';
                // é‡ç½®å›è°ƒ
                imageUpload.onchange = handleImageUpload;
            };
            imageUpload.click();
        }
    };
    
    // æ’å…¥æŒ‡å®šå¯¹é½æ–¹å¼çš„å›¾ç‰‡
    window.insertImageWithAlign = function(align) {
        const imageUpload = document.getElementById('imageUpload');
        if (imageUpload) {
            imageUpload.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'warning');
                    return;
                }
                
                showMessage('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'info');
                
                const formData = new FormData();
                formData.append('image', file);
                
                fetch('/admin/upload-image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let alignStyle = '';
                        let containerStyle = '';
                        
                        switch(align) {
                            case 'left':
                                alignStyle = 'float: left; margin: 0 1rem 1rem 0;';
                                break;
                            case 'center':
                                containerStyle = 'text-align: center;';
                                alignStyle = 'display: block; margin: 1rem auto;';
                                break;
                            case 'right':
                                alignStyle = 'float: right; margin: 0 0 1rem 1rem;';
                                break;
                        }
                        
                        let imageHtml = '';
                        if (containerStyle) {
                            imageHtml = `<div style="${containerStyle}"><img src="${data.image_url}" alt="${data.filename}" style="${alignStyle} border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>`;
                        } else {
                            imageHtml = `<img src="${data.image_url}" alt="${data.filename}" style="${alignStyle} border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
                        }
                        
                        insertMarkdown('', '', imageHtml);
                        showMessage(`å·²æ’å…¥${getAlignText(align)}å›¾ç‰‡`, 'success');
                    } else {
                        showMessage(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
                    showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'danger');
                });
                
                event.target.value = '';
                imageUpload.onchange = handleImageUpload;
            };
            imageUpload.click();
        }
    };
    
    // æ’å…¥å¹¶æ’å›¾ç‰‡
    window.insertImageInline = function() {
        showMessage('è¯·å…ˆé€‰æ‹©ç¬¬ä¸€å¼ å›¾ç‰‡', 'info');
        const imageUpload = document.getElementById('imageUpload');
        let firstImageUrl = null;
        let firstImageName = null;
        
        if (imageUpload) {
            imageUpload.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'warning');
                    return;
                }
                
                showMessage('æ­£åœ¨ä¸Šä¼ ç¬¬ä¸€å¼ å›¾ç‰‡...', 'info');
                
                const formData = new FormData();
                formData.append('image', file);
                
                fetch('/admin/upload-image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        firstImageUrl = data.image_url;
                        firstImageName = data.filename;
                        showMessage('ç¬¬ä¸€å¼ å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œè¯·é€‰æ‹©ç¬¬äºŒå¼ å›¾ç‰‡', 'success');
                        
                        // ç»§ç»­é€‰æ‹©ç¬¬äºŒå¼ å›¾ç‰‡
                        imageUpload.onchange = function(event) {
                            const file = event.target.files[0];
                            if (!file) return;
                            
                            if (!file.type.startsWith('image/')) {
                                showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'warning');
                                return;
                            }
                            
                            showMessage('æ­£åœ¨ä¸Šä¼ ç¬¬äºŒå¼ å›¾ç‰‡...', 'info');
                            
                            const formData = new FormData();
                            formData.append('image', file);
                            
                            fetch('/admin/upload-image', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // åˆ›å»ºå¹¶æ’å›¾ç‰‡HTML
                                    const inlineImagesHtml = `
<div style="display: flex; gap: 1rem; margin: 1rem 0; justify-content: center; flex-wrap: wrap;">
    <img src="${firstImageUrl}" alt="${firstImageName}" style="width: 45%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <img src="${data.image_url}" alt="${data.filename}" style="width: 45%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
</div>`;
                                    insertMarkdown('', '', inlineImagesHtml);
                                    showMessage('å·²æ’å…¥å¹¶æ’å›¾ç‰‡', 'success');
                                } else {
                                    showMessage(data.message, 'danger');
                                }
                            })
                            .catch(error => {
                                console.error('ç¬¬äºŒå¼ å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
                                showMessage('ç¬¬äºŒå¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'danger');
                            });
                            
                            event.target.value = '';
                            imageUpload.onchange = handleImageUpload;
                        };
                        imageUpload.click();
                    } else {
                        showMessage(data.message, 'danger');
                        imageUpload.onchange = handleImageUpload;
                    }
                })
                .catch(error => {
                    console.error('ç¬¬ä¸€å¼ å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
                    showMessage('ç¬¬ä¸€å¼ å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'danger');
                    imageUpload.onchange = handleImageUpload;
                });
                
                event.target.value = '';
            };
            imageUpload.click();
        }
    };
    
    // è¾…åŠ©å‡½æ•°
    function getSizeText(size) {
        switch(size) {
            case 'small': return 'å°å›¾';
            case 'medium': return 'ä¸­å›¾';
            case 'large': return 'å¤§å›¾';
            default: return 'å›¾ç‰‡';
        }
    }
    
    function getAlignText(align) {
        switch(align) {
            case 'left': return 'å·¦å¯¹é½';
            case 'center': return 'å±…ä¸­';
            case 'right': return 'å³å¯¹é½';
            default: return '';
        }
    }
    
    // ç²˜è´´å›¾ç‰‡åŠŸèƒ½
    contentField.addEventListener('paste', function(e) {
        const items = e.clipboardData.items;
        
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡
            if (item.type.indexOf('image') !== -1) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤ç²˜è´´è¡Œä¸º
                
                const file = item.getAsFile();
                if (file) {
                    showMessage('æ£€æµ‹åˆ°ç²˜è´´å›¾ç‰‡ï¼Œæ­£åœ¨ä¸Šä¼ ...', 'info');
                    
                    // åˆ›å»ºFormDataå¹¶ä¸Šä¼ 
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    fetch('/admin/upload-image', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const imageMarkdown = `![å›¾ç‰‡](${data.image_url})`;
                            insertMarkdown('', '', imageMarkdown);
                            showMessage('ç²˜è´´å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                        } else {
                            showMessage(data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('ç²˜è´´å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
                        showMessage('ç²˜è´´å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'danger');
                    });
                }
                break;
            }
        }
    });
    
    // å†…å®¹å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
    if (contentField) {
        contentField.addEventListener('input', function() {
            updatePreview();
        });
    }
    
    if (titleField) {
        titleField.addEventListener('input', function() {
            updatePreview();
        });
    }
    
    // è¡¨å•æäº¤å¤„ç†
    if (form) {
        form.addEventListener('submit', function(e) {
            // æ£€æŸ¥éªŒè¯å­—æ®µ
            if (permissionField && permissionField.value === 'verify') {
                const questionField = document.getElementById('verify-question');
                const answerField = document.getElementById('verify-answer');
                
                if (!questionField || !questionField.value.trim()) {
                    e.preventDefault();
                    showMessage('æƒé™ä¸ºéœ€è¦éªŒè¯æ—¶ï¼ŒéªŒè¯æç¤ºè¯ä¸ºå¿…å¡«é¡¹', 'danger');
                    // ç¡®ä¿éªŒè¯åŒºåŸŸæ˜¾ç¤º
                    toggleVerificationSection();
                    if (questionField) questionField.focus();
                    return false;
                }
                
                if (!answerField || !answerField.value.trim()) {
                    e.preventDefault();
                    showMessage('æƒé™ä¸ºéœ€è¦éªŒè¯æ—¶ï¼ŒéªŒè¯ç­”æ¡ˆä¸ºå¿…å¡«é¡¹', 'danger');
                    // ç¡®ä¿éªŒè¯åŒºåŸŸæ˜¾ç¤º
                    toggleVerificationSection();
                    if (answerField) answerField.focus();
                    return false;
                }
            }
            
            const originalText = submitBtn.innerHTML;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.innerHTML = '';
            const spinner = document.createElement('i');
            spinner.className = 'fas fa-spinner fa-spin me-2';
            submitBtn.appendChild(spinner);
            submitBtn.appendChild(document.createTextNode('ä¿å­˜ä¸­...'));
            submitBtn.disabled = true;
            
            // å¦‚æœè¡¨å•éªŒè¯å¤±è´¥ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                if (!form.checkValidity()) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }, 100);
        });
    }
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        // Ctrl+S ä¿å­˜
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            if (form) form.submit();
        }
        
        // Ctrl+P é¢„è§ˆ
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            previewArticle();
        }
        
        // ç¼–è¾‘å™¨å¿«æ·é”®
        if (contentField && document.activeElement === contentField) {
            // Ctrl+B ç²—ä½“
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                insertMarkdown('**', '**', 'ç²—ä½“æ–‡å­—');
            }
            
            // Ctrl+I æ–œä½“
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                insertMarkdown('*', '*', 'æ–œä½“æ–‡å­—');
            }
        }
    });
    
    // é¡µé¢åŠ è½½å®Œæˆåè¿›è¡Œæœ€ç»ˆæ£€æŸ¥
    setTimeout(function() {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¿›è¡Œæœ€ç»ˆæ£€æŸ¥');
        console.log('æƒé™å­—æ®µ:', permissionField ? permissionField.value : 'æœªæ‰¾åˆ°');
        console.log('éªŒè¯åŒºåŸŸ:', verificationSection ? 'å·²æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
        console.log('Markedåº“:', typeof marked !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
        
        // ç¡®ä¿éªŒè¯åŒºåŸŸæ­£ç¡®æ˜¾ç¤º
        if (permissionField) {
            toggleVerificationSection();
        }
    }, 1000);
});

// é¢„è§ˆåŠŸèƒ½ - ä¿®å¤æ¨¡æ€æ¡†é¢„è§ˆ
function previewArticle() {
    const title = document.getElementById('article-title');
    const content = document.getElementById('article-content');
    const modalPreviewContent = document.getElementById('modalPreviewContent');
    
    if (!title || !content || !modalPreviewContent) {
        console.error('é¢„è§ˆå…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    const titleValue = title.value;
    const contentValue = content.value;
    
    if (!titleValue.trim() && !contentValue.trim()) {
        alert('è¯·å…ˆè¾“å…¥æ ‡é¢˜æˆ–å†…å®¹');
        return;
    }
    
    let html = '';
    
    if (titleValue.trim()) {
        html += `<h1>${escapeHtml(titleValue)}</h1>`;
    }
    
    if (contentValue.trim()) {
        try {
            if (typeof marked !== 'undefined') {
                html += marked.parse(contentValue);
            } else {
                // å¤‡ç”¨markdownè½¬æ¢
                html += simpleMarkdownToHtml(contentValue);
            }
        } catch (e) {
            console.error('é¢„è§ˆè§£æé”™è¯¯:', e);
            html += `<pre>${escapeHtml(contentValue)}</pre>`;
        }
    }
    
    modalPreviewContent.innerHTML = html || '<p class="text-muted">æš‚æ— å†…å®¹</p>';
    
    // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    previewModal.show();
    
    console.log('é¢„è§ˆæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
}

// HTMLè½¬ä¹‰å‡½æ•°
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ˜¾ç¤ºæ¶ˆæ¯æç¤º
function showMessage(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    alertDiv.appendChild(document.createTextNode(message));
    
    const closeBtn = document.createElement('button');
    closeBtn.type = 'button';
    closeBtn.className = 'btn-close';
    closeBtn.setAttribute('data-bs-dismiss', 'alert');
    closeBtn.setAttribute('aria-label', 'å…³é—­');
    alertDiv.appendChild(closeBtn);
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// æ·»åŠ æµ‹è¯•æŒ‰é’®åŠŸèƒ½
function testMarkdown() {
    const content = document.getElementById('article-content');
    if (content) {
        const testMarkdown = `# ğŸ¯ MarkdownåŠŸèƒ½æµ‹è¯•

## ğŸ“ æ–‡æœ¬æ ¼å¼

è¿™æ˜¯**ç²—ä½“æ–‡å­—**å’Œ*æ–œä½“æ–‡å­—*çš„ç»„åˆæµ‹è¯•ã€‚

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨\`è¡Œå†…ä»£ç \`æ¥æ ‡è®°ä»£ç ç‰‡æ®µã€‚

## ğŸ”— é“¾æ¥å’Œå›¾ç‰‡

[è®¿é—®GitHub](https://github.com) - è¿™æ˜¯ä¸€ä¸ªå¤–éƒ¨é“¾æ¥

![ç¤ºä¾‹å›¾ç‰‡](https://via.placeholder.com/400x200/007bff/ffffff?text=æµ‹è¯•å›¾ç‰‡)

## ğŸ“‹ åˆ—è¡¨åŠŸèƒ½

### æ— åºåˆ—è¡¨
- ç¬¬ä¸€é¡¹åŠŸèƒ½
- ç¬¬äºŒé¡¹åŠŸèƒ½
- ç¬¬ä¸‰é¡¹åŠŸèƒ½
  - å­é¡¹ç›® 1
  - å­é¡¹ç›® 2

### æœ‰åºåˆ—è¡¨
1. æ­¥éª¤ä¸€
2. æ­¥éª¤äºŒ
3. æ­¥éª¤ä¸‰

## ğŸ’» ä»£ç ç¤ºä¾‹

\`\`\`javascript
// JavaScriptä»£ç ç¤ºä¾‹
function greetUser(name) {
    console.log(\`Hello, \${name}!\`);
    return \`Welcome to our blog, \${name}!\`;
}

greetUser('Claude');
\`\`\`

\`\`\`python
# Pythonä»£ç ç¤ºä¾‹
def calculate_fibonacci(n):
    if n <= 1:
        return n
    return calculate_fibonacci(n-1) + calculate_fibonacci(n-2)

print(calculate_fibonacci(10))
\`\`\`

## ğŸ”§ å…¶ä»–åŠŸèƒ½

> è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨å—çš„ç¤ºä¾‹
> å¯ä»¥ç”¨æ¥çªå‡ºé‡è¦ä¿¡æ¯

---

**æç¤º**: ç‚¹å‡»é¢„è§ˆæŒ‰é’®æŸ¥çœ‹æ¸²æŸ“æ•ˆæœï¼Œæˆ–è€…å°è¯•ä¸Šä¼ å›¾ç‰‡æµ‹è¯•åŠŸèƒ½ï¼`;
        
        content.value = testMarkdown;
        showMessage('å·²æ’å…¥å®Œæ•´çš„Markdownæµ‹è¯•å†…å®¹ï¼Œç‚¹å‡»é¢„è§ˆæŒ‰é’®æŸ¥çœ‹æ•ˆæœï¼', 'success');
    }
}

// ç®€å•markdownè½¬æ¢ï¼ˆå…¨å±€å‡½æ•°ï¼‰
function simpleMarkdownToHtml(markdown) {
    let html = markdown;
    
    // é¦–å…ˆä¿æŠ¤å·²æœ‰çš„HTMLæ ‡ç­¾ï¼ˆç‰¹åˆ«æ˜¯imgæ ‡ç­¾ï¼‰
    const htmlTags = [];
    html = html.replace(/<[^>]+>/g, function(match) {
        const index = htmlTags.length;
        htmlTags.push(match);
        return `__HTML_TAG_${index}__`;
    });
    
    // é¦–å…ˆå¤„ç†ä»£ç å—ï¼ˆé˜²æ­¢è¢«å…¶ä»–è§„åˆ™å¹²æ‰°ï¼‰
    html = html.replace(/```(\w+)?\n([\s\S]*?)```/gm, function(match, lang, code) {
        return `<pre><code class="language-${lang || 'text'}">${escapeHtml(code.trim())}</code></pre>`;
    });
    
    // å¤„ç†è¡Œå†…ä»£ç ï¼ˆå¿…é¡»åœ¨ä»£ç å—ä¹‹åå¤„ç†ï¼‰
    html = html.replace(/`([^`\n]+)`/g, '<code>$1</code>');
    
    // å¤„ç†æ ‡é¢˜
    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
    
    // å¤„ç†å›¾ç‰‡ï¼ˆå¿…é¡»åœ¨é“¾æ¥ä¹‹å‰å¤„ç†ï¼‰
    html = html.replace(/!\[([^\]]*)\]\(([^\)]*)\)/gim, '<img src="$2" alt="$1" style="max-width: 100%; height: auto; border-radius: 0.375rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">');
    
    // å¤„ç†é“¾æ¥
    html = html.replace(/\[([^\]]*)\]\(([^\)]*)\)/gim, '<a href="$2" target="_blank" style="color: #0066cc; text-decoration: underline;">$1</a>');
    
    // å¤„ç†ç²—ä½“å’Œæ–œä½“
    html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');
    
    // å¤„ç†å¼•ç”¨å—
    html = html.replace(/^> (.*$)/gim, '<blockquote style="border-left: 4px solid #dee2e6; padding-left: 1rem; margin: 1rem 0; color: #6c757d; font-style: italic;">$1</blockquote>');
    
    // å¤„ç†åˆ†éš”çº¿
    html = html.replace(/^---$/gim, '<hr style="border: none; border-top: 2px solid #dee2e6; margin: 2rem 0;">');
    
    // å¤„ç†åˆ—è¡¨
    const lines = html.split('\n');
    let inList = false;
    let processedLines = [];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const isListItem = /^[\s]*[-*+]\s+/.test(line);
        
        if (isListItem) {
            if (!inList) {
                processedLines.push('<ul>');
                inList = true;
            }
            const listContent = line.replace(/^[\s]*[-*+]\s+/, '');
            processedLines.push(`<li>${listContent}</li>`);
        } else {
            if (inList) {
                processedLines.push('</ul>');
                inList = false;
            }
            processedLines.push(line);
        }
    }
    
    if (inList) {
        processedLines.push('</ul>');
    }
    
    html = processedLines.join('\n');
    
    // å¤„ç†æ®µè½ï¼ˆé¿å…å½±å“å·²å¤„ç†çš„HTMLæ ‡ç­¾ï¼‰
    const paragraphs = html.split('\n\n');
    html = paragraphs.map(paragraph => {
        const trimmed = paragraph.trim();
        if (!trimmed) return '';
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯HTMLæ ‡ç­¾ï¼ˆæ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ç­‰ï¼‰æˆ–åŒ…å«HTMLæ ‡ç­¾å ä½ç¬¦
        if (/^<(h[1-6]|ul|ol|pre|blockquote)/.test(trimmed) || 
            /<\/(h[1-6]|ul|ol|pre|blockquote)>$/.test(trimmed) ||
            /__HTML_TAG_\d+__/.test(trimmed)) {
            return trimmed;
        }
        
        // å¤„ç†æ™®é€šæ®µè½çš„æ¢è¡Œ
        const lines = trimmed.split('\n');
        const processedParagraph = lines.join('<br>');
        
        return `<p>${processedParagraph}</p>`;
    }).filter(p => p).join('');
    
    // æ¢å¤HTMLæ ‡ç­¾
    htmlTags.forEach((tag, index) => {
        html = html.replace(`__HTML_TAG_${index}__`, tag);
    });
    
    return html;
}

console.log('JavaScriptè„šæœ¬åŠ è½½å®Œæˆ');
</script>
{% endblock %} 