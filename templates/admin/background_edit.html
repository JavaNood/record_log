{% extends "admin/base.html" %}

{% block title %}èƒŒæ™¯è®¾ç½®{% endblock %}
{% block page_title %}èƒŒæ™¯è®¾ç½®{% endblock %}
{% block page_subtitle %}ä¸Šä¼ å’Œè®¾ç½®ç½‘ç«™èƒŒæ™¯å›¾ç‰‡{% endblock %}

{% block extra_css %}
<style>
.preview-container {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    height: 300px;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 25%, #90caf9 50%, #e1f5fe 75%, #f0f8ff 100%);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: local;
    margin-bottom: 1rem;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.preview-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    bottom: 10px;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.1rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    border-radius: 8px;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.preview-container.has-image .preview-overlay {
    display: none;
}

.upload-card {
    transition: transform 0.2s ease;
}

.upload-card:hover {
    transform: translateY(-2px);
}

.file-input-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
    width: 100%;
}

.file-input-wrapper input[type=file] {
    position: absolute;
    left: -9999px;
}

.file-input-label {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.1);
}

.file-input-label:hover {
    border-color: #007bff;
    background: rgba(0, 123, 255, 0.05);
}

.file-input-label.dragover {
    border-color: #007bff;
    background: rgba(0, 123, 255, 0.1);
    transform: scale(1.02);
}

.slider-container {
    margin: 1rem 0;
}

.blur-slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #ddd;
    outline: none;
    transition: background 0.3s;
}

.blur-slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.blur-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.blur-value {
    display: inline-block;
    min-width: 30px;
    text-align: center;
    font-weight: bold;
    color: #007bff;
}

.current-bg-info {
    font-size: 0.875rem;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    margin-bottom: 1rem;
}

.bg-fit-options {
    display: flex;
    gap: 10px;
    margin: 1rem 0;
}

.bg-fit-option {
    flex: 1;
    text-align: center;
    padding: 0.5rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.1);
}

.bg-fit-option.active {
    border-color: #007bff;
    background: rgba(0, 123, 255, 0.1);
    color: #007bff;
}

.bg-fit-option:hover {
    border-color: #007bff;
}

.preset-bg-option {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    height: 100px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid transparent;
}

.preset-bg-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    border-color: #007bff;
}

.preset-bg-option.active {
    border-color: #28a745;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
}

/* åŠ¨æ€èƒŒæ™¯ç‰¹æ®Šæ ·å¼ */
.preset-bg-option.animated {
    position: relative;
    overflow: hidden;
}

.preset-bg-option.animated::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%);
    background-size: 20px 20px;
    animation: animate-stripe 2s linear infinite;
    z-index: 1;
}

.preset-bg-option.animated .preset-overlay {
    z-index: 2;
    position: relative;
}

@keyframes animate-stripe {
    0% { background-position: 0 0; }
    100% { background-position: 20px 20px; }
}

.preset-bg-option.animated.rain-preview::after {
    content: 'ğŸŒ§ï¸';
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 1.5em;
    z-index: 3;
    animation: bounce 2s ease-in-out infinite;
}

.preset-bg-option.animated.ocean-preview::after {
    content: 'ğŸŒŠ';
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 1.5em;
    z-index: 3;
    animation: wave-bounce 3s ease-in-out infinite;
}

.preset-bg-option.animated.snow-preview::after {
    content: 'â„ï¸';
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 1.5em;
    z-index: 3;
    animation: float 4s ease-in-out infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

@keyframes wave-bounce {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    50% { transform: translateX(5px) rotate(5deg); }
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-10px) rotate(180deg); }
}

.preset-preview {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.preset-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 0.75rem;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    transition: background 0.3s ease;
}

.preset-bg-option:hover .preset-overlay {
    background: rgba(0, 0, 0, 0.3);
}

.preset-active-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: #28a745;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.75rem;
}

</style>
{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜å’Œè¿”å›æŒ‰é’® -->
<div class="d-flex align-items-center mb-4">
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary me-3" title="è¿”å›ç®¡ç†ä¸»ç•Œé¢">
        <i class="fas fa-arrow-left me-1"></i>è¿”å›ä¸»ç•Œé¢
    </a>
    <h2 class="mb-0">
        <i class="fas fa-image me-2"></i>èƒŒæ™¯è®¾ç½®
    </h2>
</div>

<div class="row">
    <!-- é¢„è®¾èƒŒæ™¯é€‰æ‹©åŒºåŸŸ -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-palette me-2"></i>é¢„è®¾èƒŒæ™¯ä¸»é¢˜
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="presetBackgroundForm">
                    <div class="row">
                        {% for key, bg in preset_backgrounds.items() %}
                        <div class="col-md-4 mb-3">
                            <div class="preset-bg-option {% if 'animated' in key %}animated {% if 'rain' in key %}rain-preview{% elif 'ocean' in key %}ocean-preview{% elif 'snow' in key %}snow-preview{% endif %}{% endif %}" data-preset="{{ key }}">
                                <div class="preset-preview" style="background: {{ bg.gradient }};">
                                    <div class="preset-overlay">
                                        <h6 class="text-white">{{ bg.name }}</h6>
                                        <small class="text-white-50">{{ bg.description }}</small>
                                        {% if 'animated' in key %}
                                        <div class="mt-2">
                                            <span class="badge bg-primary">åŠ¨æ€æ•ˆæœ</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% if current_preset == key and background_type == 'preset' %}
                                    <div class="preset-active-indicator">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- æ—¶é—´å˜åŒ–å¼€å…³ -->
                    <div class="mt-4 p-3 border rounded">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" 
                                   id="time_based_background" 
                                   name="time_based_background" 
                                   {{ 'checked' if time_based else '' }}>
                            <label class="form-check-label fw-bold" for="time_based_background">
                                <i class="fas fa-clock me-2"></i>å¯ç”¨æ—¶é—´å˜åŒ–èƒŒæ™¯
                            </label>
                        </div>
                        <small class="text-muted mt-2 d-block">
                            å¼€å¯åèƒŒæ™¯å°†æ ¹æ®æ—¶é—´è‡ªåŠ¨å˜åŒ–ï¼š
                            ä¸Šåˆ(6-11ç‚¹)æ˜¥æ—¥æš–é˜³ï¼Œä¸­åˆ(11-15ç‚¹)è“å¤©ç™½äº‘ï¼Œä¸‹åˆ(15-18ç‚¹)æ·±æµ·è“è°ƒï¼Œ
                            å‚æ™š(18-22ç‚¹)é»„æ˜å¤•é˜³ï¼Œå¤œæ™š(22-6ç‚¹)æ˜Ÿç©ºå¤œè‰²
                        </small>
                        <div class="mt-2">
                            <button type="submit" name="update_time_setting" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-save me-1"></i>æ›´æ–°æ—¶é—´è®¾ç½®
                            </button>
                        </div>
                    </div>
                    
                    <input type="hidden" name="preset_background" id="selectedPreset" value="">
                </form>
            </div>
        </div>
    </div>
    
    <!-- èƒŒæ™¯é¢„è§ˆå’Œè®¾ç½® -->
    <div class="col-lg-8">
        <div class="card upload-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-image me-2"></i>èƒŒæ™¯é¢„è§ˆ
                </h5>
            </div>
            <div class="card-body">
                <div class="preview-container" id="bgPreview"
                     {% if current_background %}
                     style="background-image: url('{{ current_background }}'); --bg-size: var(--current-bg-size, cover);"
                     data-has-image="true"
                     {% endif %}>
                    {% if not current_background %}
                    <div class="preview-overlay">
                        <div class="text-center">
                            <i class="fas fa-image fa-2x mb-2"></i>
                            <br>
                            é€‰æ‹©å›¾ç‰‡åå°†æ˜¾ç¤ºé¢„è§ˆ
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- èƒŒæ™¯é€‚é…é€‰é¡¹ -->
                <div class="bg-fit-options">
                    <div class="bg-fit-option" data-fit="cover">
                        <i class="fas fa-expand-arrows-alt d-block mb-1"></i>
                        <small>è¦†ç›–å¡«æ»¡</small>
                        <div class="small text-muted">å¯èƒ½è£å‰ª</div>
                    </div>
                    <div class="bg-fit-option" data-fit="contain">
                        <i class="fas fa-compress-arrows-alt d-block mb-1"></i>
                        <small>å®Œæ•´æ˜¾ç¤º</small>
                        <div class="small text-muted">å¯èƒ½æœ‰è¾¹è·</div>
                    </div>
                    <div class="bg-fit-option" data-fit="100% 100%">
                        <i class="fas fa-arrows-alt d-block mb-1"></i>
                        <small>æ‹‰ä¼¸å¡«æ»¡</small>
                        <div class="small text-muted">å¯èƒ½å˜å½¢</div>
                    </div>
                </div>
                
                <!-- å½“å‰èƒŒæ™¯ä¿¡æ¯ -->
                {% if current_background %}
                <div class="current-bg-info">
                    <i class="fas fa-info-circle me-2"></i>
                    å½“å‰èƒŒæ™¯ï¼š{{ current_background.split('/')[-1] }}
                    <span class="ms-3">
                        <i class="fas fa-blur me-1"></i>
                        è™šåŒ–çº§åˆ«ï¼š{{ blur_level }}
                    </span>
                </div>
                {% endif %}
                
                <!-- ä¸Šä¼ è¡¨å• -->
                <form method="POST" enctype="multipart/form-data" id="backgroundForm">
                    <div class="file-input-wrapper">
                        <input type="file" 
                               id="background_image" 
                               name="background_image" 
                               accept="image/*"
                               class="form-control"
                               title="é€‰æ‹©èƒŒæ™¯å›¾ç‰‡æ–‡ä»¶"
                               aria-label="èƒŒæ™¯å›¾ç‰‡æ–‡ä»¶é€‰æ‹©"
                               aria-describedby="fileLabel">
                        <label for="background_image" class="file-input-label" id="fileLabel">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-3 text-primary" aria-hidden="true"></i>
                            <h6>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </h6>
                            <p class="text-muted mb-0">
                                æ”¯æŒ PNGã€JPGã€JPEGã€GIFã€WebPã€BMP æ ¼å¼
                            </p>
                        </label>
                    </div>
                    
                    <!-- è™šåŒ–çº§åˆ«æ§åˆ¶ -->
                    <div class="slider-container">
                        <label class="form-label">
                            <i class="fas fa-adjust me-2"></i>è™šåŒ–çº§åˆ«ï¼š
                            <span class="blur-value" id="blurValue">{{ blur_level }}</span>
                        </label>
                        <input type="range" 
                               class="blur-slider" 
                               id="blur_level" 
                               name="blur_level" 
                               min="0" 
                               max="30" 
                               value="{{ blur_level }}"
                               step="1"
                               title="è°ƒæ•´èƒŒæ™¯è™šåŒ–ç¨‹åº¦"
                               aria-label="è™šåŒ–çº§åˆ«æ»‘å—"
                               aria-describedby="blurValue">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">æ¸…æ™°</small>
                            <small class="text-muted">é‡åº¦è™šåŒ–</small>
                        </div>
                    </div>
                    
                    <!-- éšè—çš„èƒŒæ™¯é€‚é…æ–¹å¼å­—æ®µ -->
                    <input type="hidden" id="bg_fit_mode" name="bg_fit_mode" value="cover">
                    

                    
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>åº”ç”¨è®¾ç½®
                        </button>
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>è¿”å›é¦–é¡µ
                        </a>
                        {% if current_background %}
                        <button type="button" class="btn btn-outline-danger" id="resetBtn">
                            <i class="fas fa-undo me-2"></i>é‡ç½®é»˜è®¤
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ç®€åŒ–çš„è®¾ç½®è¯´æ˜ -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>ä½¿ç”¨è¯´æ˜
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong class="text-primary">ä¸Šä¼ å›¾ç‰‡ï¼š</strong>
                    <p class="mb-2">æ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼ï¼Œè‡ªåŠ¨ä¼˜åŒ–å°ºå¯¸ï¼Œä¿æŒé«˜è´¨é‡</p>
                </div>
                
                <div class="mb-3">
                    <strong class="text-primary">é€‚é…æ–¹å¼ï¼š</strong>
                    <p class="mb-2">
                        <strong>è¦†ç›–å¡«æ»¡</strong>ï¼šå›¾ç‰‡æ”¾å¤§å¡«æ»¡å±å¹•ï¼Œå¯èƒ½è¢«è£å‰ª<br>
                        <strong>å®Œæ•´æ˜¾ç¤º</strong>ï¼šå®Œæ•´æ˜¾ç¤ºå›¾ç‰‡ï¼Œå¯èƒ½æœ‰ç©ºç™½è¾¹è·<br>
                        <strong>æ‹‰ä¼¸å¡«æ»¡</strong>ï¼šå¼ºåˆ¶æ‹‰ä¼¸å¡«æ»¡ï¼Œå¯èƒ½å˜å½¢
                    </p>
                </div>
                
                <div class="mb-3">
                    <strong class="text-primary">è™šåŒ–æ•ˆæœï¼š</strong>
                    <p class="mb-2">0=æ¸…æ™°ï¼Œ10=è½»å¾®è™šåŒ–(æ¨è)ï¼Œ30=é‡åº¦è™šåŒ–</p>
                </div>
                
                <div class="mb-3">
                    <strong class="text-primary">ä¸Šä¼ åº”ç”¨ï¼š</strong>
                    <p class="mb-2">é€‰æ‹©å›¾ç‰‡åç›´æ¥ç‚¹å‡»"åº”ç”¨è®¾ç½®"ä¸Šä¼ å¹¶æŸ¥çœ‹æ•ˆæœ</p>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>æç¤ºï¼š</strong>å»ºè®®ä½¿ç”¨é£æ™¯å›¾ç‰‡ï¼Œæ¨èä½¿ç”¨"å®Œæ•´æ˜¾ç¤º"é¿å…è£å‰ª
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('background_image');
    const fileLabel = document.getElementById('fileLabel');
    const blurSlider = document.getElementById('blur_level');
    const blurValue = document.getElementById('blurValue');
    const bgPreview = document.getElementById('bgPreview');
    const resetBtn = document.getElementById('resetBtn');

    const bgFitOptions = document.querySelectorAll('.bg-fit-option');
    const bgFitModeInput = document.getElementById('bg_fit_mode');
    
    // é¢„è®¾èƒŒæ™¯é€‰æ‹©
    const presetOptions = document.querySelectorAll('.preset-bg-option');
    const selectedPresetInput = document.getElementById('selectedPreset');
    
    // åˆå§‹åŒ–é¢„è®¾èƒŒæ™¯é€‰æ‹©çŠ¶æ€
    const currentBackgroundType = '{{ background_type }}';
    const currentPreset = '{{ current_preset }}';
    
    if (currentBackgroundType === 'preset') {
        presetOptions.forEach(option => {
            if (option.dataset.preset === currentPreset) {
                option.classList.add('active');
            }
        });
    }
    
    // é¢„è®¾èƒŒæ™¯ç‚¹å‡»äº‹ä»¶
    presetOptions.forEach(option => {
        option.addEventListener('click', function() {
            const preset = this.dataset.preset;
            
            // æ¸…é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            presetOptions.forEach(opt => opt.classList.remove('active'));
            
            // è®¾ç½®å½“å‰é€‰ä¸­
            this.classList.add('active');
            selectedPresetInput.value = preset;
            
            // æäº¤è¡¨å•
            document.getElementById('presetBackgroundForm').submit();
        });
    });
    
    // åˆå§‹åŒ–èƒŒæ™¯é€‚é…é€‰é¡¹
    const currentFitMode = '{{ fit_mode }}'; // ä»åç«¯è·å–å½“å‰æ¨¡å¼
    bgFitOptions.forEach(option => {
        const fitMode = option.dataset.fit;
        if (fitMode === currentFitMode) {
            option.classList.add('active');
        }
        
        option.addEventListener('click', function() {
            bgFitOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            bgFitModeInput.value = fitMode;
            
            // æ›´æ–°é¢„è§ˆ
            updatePreview();
        });
    });
    
    // è®¾ç½®åˆå§‹çš„èƒŒæ™¯é€‚é…æ–¹å¼
    bgFitModeInput.value = currentFitMode;
    
    // åˆå§‹åŒ–é¢„è§ˆçŠ¶æ€
    {% if current_background %}
    const overlay = bgPreview.querySelector('.preview-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    bgPreview.classList.add('has-image');
    {% endif %}
    
    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    fileInput.addEventListener('change', function(e) {
        console.log('æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘:', e.target.files);
        console.log('æ–‡ä»¶æ•°é‡:', e.target.files.length);
        
        if (e.target.files.length > 0) {
            const selectedFile = e.target.files[0];
            const fileName = selectedFile.name;
            console.log('æ–‡ä»¶å·²é€‰æ‹©:', fileName, selectedFile.type, selectedFile.size);
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!e.target.files[0].type.startsWith('image/')) {
                console.log('æ–‡ä»¶ç±»å‹ä¸æ˜¯å›¾ç‰‡:', e.target.files[0].type);
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                e.target.value = '';
                return;
            }
            
            fileLabel.innerHTML = `
                <i class="fas fa-check fa-2x mb-3 text-success" aria-hidden="true"></i>
                <h6>å·²é€‰æ‹©ï¼š${fileName}</h6>
                <p class="text-muted mb-0">ç‚¹å‡»"åº”ç”¨è®¾ç½®"ä¸Šä¼ å›¾ç‰‡</p>
            `;
            
        } else {
            console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
        }
    });
    
    // æ›´æ–°é¢„è§ˆï¼ˆä¸æ”¹å˜å›¾ç‰‡ï¼Œåªæ”¹å˜æ•ˆæœï¼‰
    function updatePreview() {
        const currentImage = bgPreview.style.backgroundImage;
        if (currentImage && currentImage !== 'none' && currentImage !== '') {
            const currentBlur = blurSlider.value;
            const fitMode = bgFitModeInput.value;
            
            // è®¾ç½®èƒŒæ™¯å°ºå¯¸æ¨¡å¼
            if (fitMode === 'contain') {
                bgPreview.style.backgroundSize = 'contain';
            } else if (fitMode === '100% 100%') {
                bgPreview.style.backgroundSize = '100% 100%';
            } else {
                bgPreview.style.backgroundSize = 'cover';
            }
            
            // åº”ç”¨è™šåŒ–æ•ˆæœ
            bgPreview.style.filter = currentBlur > 0 ? `blur(${currentBlur}px)` : 'none';
            
            console.log('é¢„è§ˆæ•ˆæœæ›´æ–°:', {fitMode, blur: currentBlur});
        }
    }
    
    // æ‹–æ‹½ä¸Šä¼ 
    fileLabel.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    fileLabel.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });
    
    fileLabel.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        }
    });
    
    // è™šåŒ–çº§åˆ«å®æ—¶æ›´æ–°
    blurSlider.addEventListener('input', function(e) {
        blurValue.textContent = e.target.value;
        updatePreview();
    });
    
    // é‡ç½®èƒŒæ™¯
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤èƒŒæ™¯å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤å½“å‰èƒŒæ™¯å›¾ç‰‡ã€‚')) {
                fetch('{{ url_for("admin.reset_background") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('é‡ç½®å¤±è´¥ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    alert('é‡ç½®å¤±è´¥ï¼š' + error.message);
                });
            }
        });
    }
    
    // è¡¨å•æäº¤å¤„ç†
    document.getElementById('backgroundForm').addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2" aria-hidden="true"></i>å¤„ç†ä¸­...';
        submitBtn.disabled = true;
        
        // å¦‚æœæ²¡æœ‰æ–‡ä»¶ä½†æœ‰è™šåŒ–çº§åˆ«å˜åŒ–ï¼Œä¹Ÿè¦æäº¤
        const hasFile = fileInput.files.length > 0;
        const originalBlur = {{ blur_level }};
        const currentBlur = parseInt(blurSlider.value);
        
        if (!hasFile && originalBlur === currentBlur) {
            e.preventDefault();
            submitBtn.innerHTML = '<i class="fas fa-save me-2" aria-hidden="true"></i>åº”ç”¨è®¾ç½®';
            submitBtn.disabled = false;
            alert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–è°ƒæ•´è®¾ç½®');
        }
    });
});
</script>
{% endblock %} 